<!DOCTYPE html>
<html>
<head>
  <title>Mapa con Buffer y Puntos</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    #map {
      height: 400px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- Biblioteca para realizar solicitudes HTTP -->
  <script src="https://cdn.jsdelivr.net/npm/turf"></script> <!-- Biblioteca para realizar cálculos geoespaciales -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet.buffer"></script> <!-- Plugin Leaflet para generar buffers -->
  <script>
    var map = L.map('map').setView([0, 0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; OpenStreetMap contributors'
    }).addTo(map);
  
    var bufferLayer;
  
    // Obtener la ubicación actual del usuario
    navigator.geolocation.getCurrentPosition(function(position) {
      var latitude = position.coords.latitude;
      var longitude = position.coords.longitude;
  
      var location = L.latLng(latitude, longitude);
      var bufferRadius = 1000; // Valor inicial del radio del buffer en metros
  
      var bufferOptions = {
        steps: 64,
        units: 'meters',
        style: {
          color: 'blue',
          fillColor: 'lightblue',
          fillOpacity: 0.5
        }
      };
  
      // Crear el control deslizante para ajustar el tamaño del buffer
      var bufferSlider = L.control.slider(function(value) {
        bufferRadius = value;
        updateBuffer();
      }, {
        id: 'bufferSlider',
        min: 100,
        max: 2000,
        step: 100,
        value: bufferRadius,
        size: '300px',
        orientation: 'horizontal',
        position: 'topright',
        collapsed: false,
        title: 'Buffer Radius'
      }).addTo(map);
  
      // Actualizar el buffer y los puntos cuando cambie el tamaño del buffer
      function updateBuffer() {
        if (bufferLayer) {
          map.removeLayer(bufferLayer);
        }
  
        // Realizar una solicitud HTTP a get_points.php para obtener los puntos dentro del buffer
        var url = '17.php?lat=' + latitude + '&lng=' + longitude + '&radius=' + bufferRadius;
        axios.get(url)
          .then(function(response) {
            var pointsInBuffer = response.data;
  
            // Crear una capa GeoJSON para los puntos dentro del buffer
            var pointsInBufferLayer = L.geoJSON(pointsInBuffer, {
              onEachFeature: function(feature, layer) {
                layer.bindPopup('<b>ID:</b> ' + feature.properties.id + '<br><b>Nombre:</b> ' + feature.properties.nombre);
              }
            }).addTo(map);
  
            // Crear el buffer y agregarlo al mapa
            bufferLayer = L.buffer(pointsInBufferLayer, bufferRadius, bufferOptions).addTo(map);
          })
          .catch(function(error) {
            console.error('Error al obtener los puntos: ' + error);
          });
      }
  
      // Ajustar la vista del mapa a la ubicación actual
      map.setView(location, 13);
  
      // Actualizar el buffer inicialmente
      updateBuffer();
    }, function(error) {
      console.error('Error al obtener la ubicación: ' + error.message);
    });
  </script>
  
</body>
</html>
