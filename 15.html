<!DOCTYPE html>
<html>
<head>
    <title>Mapa con buffer y puntos de PostgreSQL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet-geoman-free@3.5.0/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pg-promise@10.8.4/dist/pg-promise.min.js"></script>
    <style>
        #map {
            height: 400px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    

    <script>
        var map = L.map('map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; OpenStreetMap contributors'
        }).addTo(map);

        var userLocation;
        var bufferLayer;
        var dbInstance;

        // Obtener la ubicación actual del usuario
        navigator.geolocation.getCurrentPosition(function(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            userLocation = turf.point([longitude, latitude]);
            var radius = 1000; // Radio del buffer en metros

            var buffered = turf.buffer(userLocation, radius, { units: 'meters' });
            var bufferGeoJSON = L.geoJSON(buffered);

            bufferLayer = L.featureGroup([bufferGeoJSON]).addTo(map);
            map.fitBounds(bufferLayer.getBounds());

            var connection = {
                host: 'localhost',
                port: 5433,
                database: 'nombre_base_datos',
                user: 'usuario',
                password: 'contraseña'
            };

            dbInstance = pgp(connection);
            fetchDataFromDatabase(buffered);
        }, function(error) {
            console.error('Error al obtener la ubicación: ' + error.message);
        });

        // Función para obtener los puntos de la base de datos dentro del buffer
        function fetchDataFromDatabase(buffered) {
            var sql = `
                SELECT *
                FROM puntos
                WHERE ST_Within(geom, ST_GeomFromGeoJSON($1))
            `;

            var bufferGeoJSON = JSON.stringify(buffered.geometry);

            dbInstance.any(sql, [bufferGeoJSON])
                .then(function(data) {
                    data.forEach(function(point) {
                        var marker = L.marker([point.lat, point.lng]).addTo(map);
                        // Personaliza el marcador según tus necesidades
                    });
                })
                .catch(function(error) {
                    console.error('Error al realizar la consulta: ' + error);
                });
        }
    </script>
</body>
</html>
